{% extends "base.html" %}

{% block title %}Buy Medicines - Healthcare Portal{% endblock %}

{% block extra_css %}
<style>
.medicines-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    text-align: center;
}

.filters-section {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filter-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 300px;
}

.search-input {
    width: 100%;
    padding: 12px 20px;
    border: 2px solid #e1e5e9;
    border-radius: 25px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-select {
    padding: 12px 15px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 1rem;
    min-width: 150px;
}

.medicines-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.medicine-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.medicine-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.medicine-image {
    width: 100%;
    height: 220px;
    object-fit: cover;
    background: #f8f9fa;
}

.card-content {
    padding: 1.5rem;
}

.medicine-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2d3436;
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.manufacturer {
    color: #636e72;
    font-size: 0.95rem;
    margin-bottom: 1rem;
    font-weight: 500;
}

.price-stock-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #00b894;
}

.stock {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.stock-available {
    background: #d1edff;
    color: #0984e3;
}

.stock-low {
    background: #ffeaa7;
    color: #fdcb6e;
}

.stock-out {
    background: #fab1a0;
    color: #e17055;
}

.prescription-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #e84393;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.card-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
    font-size: 0.95rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-outline {
    background: transparent;
    border: 2px solid #667eea;
    color: #667eea;
}

.btn-outline:hover {
    background: #667eea;
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
}

.pagination a, .pagination span {
    padding: 10px 15px;
    border: 1px solid #ddd;
    text-decoration: none;
    border-radius: 5px;
    color: #667eea;
}

.pagination .current {
    background: #667eea;
    color: white;
}
.back-button {
    position: fixed;
    top: 100px;
    left: 20px;
    background: var(--white);
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    z-index: 1000;
    box-shadow: var(--shadow);
}

.back-button:hover {
    background: var(--primary-color);
    color: var(--white);
    transform: scale(1.1);
}

.no-medicines {
    text-align: center;
    padding: 4rem;
    color: #636e72;
}

.cart-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #00b894;
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,184,148,0.3);
}

@media (max-width: 768px) {
    .medicines-grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .filter-row {
        flex-direction: column;
        align-items: stretch;
    }

    .search-box {
        min-width: auto;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Back Button -->
<a href="javascript:history.back()" class="back-button" title="Go Back">
    ‚Üê
</a>

<div class="medicines-container">
    <!-- Header -->
    <div class="page-header">
        <h1>üíä Buy Medicines</h1>
        <p>Find and purchase quality medicines from trusted manufacturers</p>
    </div>

    <!-- Cart Indicator -->
    {% if cart_count > 0 %}
    <div class="cart-indicator">
        üõí Cart: {{ cart_count }} items
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="filters-section">
        <form method="GET" class="filter-row">
            <div class="search-box">
                <input type="text" name="search" class="search-input" 
                       placeholder="üîç Search medicines, manufacturers ..."
                       value="{{ search }}">
            </div>

            <select name="category" class="filter-select">
                <option value="">All Categories</option>
                {% for category in categories %}
                <option value="{{ category }}" {{ 'selected' if category == current_category }}>
                    {{ category }}
                </option>
                {% endfor %}
            </select>

            <select name="sort" class="filter-select">
                <option value="name" {{ 'selected' if sort_by == 'name' }}>Sort by Name</option>
                <option value="price_low" {{ 'selected' if sort_by == 'price_low' }}>Price: Low to High</option>
                <option value="price_high" {{ 'selected' if sort_by == 'price_high' }}>Price: High to Low</option>
                <option value="stock" {{ 'selected' if sort_by == 'stock' }}>Stock Available</option>
            </select>

            <button type="submit" class="btn btn-primary" style="flex: none; padding: 12px 20px;">
                Apply Filters
            </button>
        </form>
    </div>

    <!-- Results Info -->
    {% if medicines %}
    <div style="margin-bottom: 1rem; color: #636e72;">
        Showing {{ medicines|length }} of {{ total_medicines }} medicines
        {% if search %} for "{{ search }}"{% endif %}
        {% if current_category %} in {{ current_category }}{% endif %}
    </div>
    {% endif %}

    <!-- Medicines Grid -->
    {% if medicines %}
    <div class="medicines-grid">
        {% for medicine in medicines %}
        <div class="medicine-card" onclick="window.location.href='{{ url_for('medicine_details', medicine_id=medicine.id) }}'">
            {% if medicine.prescription_required %}
            <div class="prescription-badge">Rx Required</div>
            {% endif %}

            <img src="{{ medicine.medicine_image or '/static/images/default-medicine.jpg' }}" 
                 alt="{{ medicine.name }}" class="medicine-image"
                 onerror="this.src='/static/images/default-medicine.jpg'">

            <div class="card-content">
                <h3 class="medicine-name">{{ medicine.name }}</h3>
                <div class="manufacturer">{{ medicine.manufacturer }}</div>

                <div class="price-stock-row">
                    <div class="price">‚Çπ{{ "%.2f"|format(medicine.price) }}</div>
                    <div class="stock {{ 'stock-out' if medicine.stock_quantity == 0 else 'stock-low' if medicine.stock_quantity < 10 else 'stock-available' }}">
                        {% if medicine.stock_quantity == 0 %}
                            Out of Stock
                        {% elif medicine.stock_quantity < 10 %}
                            {{ medicine.stock_quantity }} left
                        {% else %}
                            In Stock
                        {% endif %}
                    </div>
                </div>

                <div class="card-buttons">
                    {% if medicine.stock_quantity > 0 %}
                    <button class="btn btn-primary buy-now-btn" 
                            data-medicine-id="{{ medicine.id }}"
                            onclick="event.stopPropagation(); buyNow({{ medicine.id }})">
                        Buy Now
                    </button>
                    <button class="btn btn-outline add-to-cart-btn" 
                            data-medicine-id="{{ medicine.id }}"
                            onclick="event.stopPropagation(); addToCart({{ medicine.id }})">
                        Add to Cart
                    </button>
                    {% else %}
                    <button class="btn btn-primary" disabled>Out of Stock</button>
                    <button class="btn btn-outline" disabled>Unavailable</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('buy_medicines', page=page-1, search=search, category=current_category, sort=sort_by) }}">
            Previous
        </a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="current">{{ p }}</span>
            {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
            <a href="{{ url_for('buy_medicines', page=p, search=search, category=current_category, sort=sort_by) }}">
                {{ p }}
            </a>
            {% elif p == 4 and page > 5 %}
            <span>...</span>
            {% elif p == total_pages - 3 and page < total_pages - 4 %}
            <span>...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="{{ url_for('buy_medicines', page=page+1, search=search, category=current_category, sort=sort_by) }}">
            Next
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="no-medicines">
        <h3>No medicines found</h3>
        <p>Try adjusting your search criteria or browse all categories.</p>
        <a href="{{ url_for('buy_medicines') }}" class="btn btn-primary">View All Medicines</a>
    </div>
    {% endif %}
</div>

<script>
function addToCart(medicineId) {
    fetch('/add-to-cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `medicine_id=${medicineId}&quantity=1`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart indicator
            updateCartIndicator(data.cart_count);

            // Show success message
            showNotification(data.message, 'success');

            // Update button temporarily
            const button = document.querySelector(`[data-medicine-id="${medicineId}"].add-to-cart-btn`);
            const originalText = button.innerHTML;
            button.innerHTML = '‚úì Added';
            button.style.background = '#00b894';
            button.style.color = 'white';

            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '';
                button.style.color = '';
            }, 2000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error adding to cart', 'error');
    });
}

function buyNow(medicineId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/buy-now';

    const medicineInput = document.createElement('input');
    medicineInput.type = 'hidden';
    medicineInput.name = 'medicine_id';
    medicineInput.value = medicineId;

    const quantityInput = document.createElement('input');
    quantityInput.type = 'hidden';
    quantityInput.name = 'quantity';
    quantityInput.value = 1;

    form.appendChild(medicineInput);
    form.appendChild(quantityInput);
    document.body.appendChild(form);
    form.submit();
}

function updateCartIndicator(count) {
    const indicator = document.querySelector('.cart-indicator');
    if (count > 0) {
        if (indicator) {
            indicator.innerHTML = `üõí Cart: ${count} items`;
        } else {
            const newIndicator = document.createElement('div');
            newIndicator.className = 'cart-indicator';
            newIndicator.innerHTML = `üõí Cart: ${count} items`;
            document.body.appendChild(newIndicator);
        }
    }
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        max-width: 300px;
        background: ${type === 'success' ? '#00b894' : '#e17055'};
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    notification.innerHTML = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}